{"version":3,"file":"plugins/plugin.text_selection.js","mappings":"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","sources":["webpack://@internetarchive/bookreader/./src/BookReader/utils/SelectionObserver.js","webpack://@internetarchive/bookreader/./src/plugins/plugin.text_selection.js","webpack://@internetarchive/bookreader/./src/util/strings.js"],"sourcesContent":["// @ts-check\r\nexport class SelectionObserver {\r\n  selecting = false;\r\n  startedInSelector = false;\r\n  /** @type {HTMLElement} */\r\n  target = null;\r\n\r\n  /**\r\n   * @param {string} selector\r\n   * @param {function('started' | 'cleared', HTMLElement): any} handler\r\n   */\r\n  constructor(selector, handler) {\r\n    this.selector = selector;\r\n    this.handler = handler;\r\n  }\r\n\r\n  attach() {\r\n    // We can't just use selectstart, because safari on iOS just\r\n    // randomly decides when to fire it 😤\r\n    // document.addEventListener(\"selectstart\", this._onSelectStart);\r\n    // This has to be on document :/\r\n    document.addEventListener(\"selectionchange\", this._onSelectionChange);\r\n  }\r\n\r\n  detach() {\r\n    document.removeEventListener(\"selectionchange\", this._onSelectionChange);\r\n  }\r\n\r\n  _onSelectionChange = () => {\r\n    const sel = window.getSelection();\r\n\r\n    if (!this.selecting && sel.toString()) {\r\n      const target = $(sel.anchorNode).closest(this.selector)[0];\r\n      if (!target) return;\r\n      this.target = target;\r\n      this.selecting = true;\r\n      this.handler('started', this.target);\r\n    }\r\n\r\n    if (this.selecting && (sel.isCollapsed || !sel.toString() || !$(sel.anchorNode).closest(this.selector)[0])) {\r\n      this.selecting = false;\r\n      this.handler('cleared', this.target);\r\n    }\r\n  };\r\n}\r\n","//@ts-check\r\nimport { createDIVPageLayer } from '../BookReader/PageContainer.js';\r\nimport { SelectionObserver } from '../BookReader/utils/SelectionObserver.js';\r\nimport { applyVariables } from '../util/strings.js';\r\n/** @typedef {import('../util/strings.js').StringWithVars} StringWithVars */\r\n/** @typedef {import('../BookReader/PageContainer.js').PageContainer} PageContainer */\r\n\r\nconst BookReader = /** @type {typeof import('../BookReader').default} */(window.BookReader);\r\n\r\nexport const DEFAULT_OPTIONS = {\r\n  enabled: true,\r\n  /** @type {StringWithVars} The URL to fetch the entire DJVU xml. Supports options.vars */\r\n  fullDjvuXmlUrl: null,\r\n  /** @type {StringWithVars} The URL to fetch a single page of the DJVU xml. Supports options.vars. Also has {{pageIndex}} */\r\n  singlePageDjvuXmlUrl: null,\r\n  /** Whether to fetch the XML as a jsonp */\r\n  jsonp: false,\r\n};\r\n/** @typedef {typeof DEFAULT_OPTIONS} TextSelectionPluginOptions */\r\n\r\n/**\r\n * @template T\r\n */\r\nexport class Cache {\r\n  constructor(maxSize = 10) {\r\n    this.maxSize = maxSize;\r\n    /** @type {T[]} */\r\n    this.entries = [];\r\n  }\r\n\r\n  /**\r\n   * @param {T} entry\r\n   */\r\n  add(entry) {\r\n    if (this.entries.length >= this.maxSize) {\r\n      this.entries.shift();\r\n    }\r\n    this.entries.push(entry);\r\n  }\r\n}\r\n\r\nexport class TextSelectionPlugin {\r\n  /**\r\n   * @param {'lr' | 'rl'} pageProgression In the future this should be in the ocr file\r\n   * since a book being right to left doesn't mean the ocr is right to left. But for\r\n   * now we do make that assumption.\r\n   */\r\n  constructor(options = DEFAULT_OPTIONS, optionVariables, pageProgression = 'lr') {\r\n    this.options = options;\r\n    this.optionVariables = optionVariables;\r\n    /**@type {PromiseLike<JQuery<HTMLElement>|undefined>} */\r\n    this.djvuPagesPromise = null;\r\n    /** Whether the book is right-to-left */\r\n    this.rtl = pageProgression === 'rl';\r\n\r\n    /** @type {Cache<{index: number, response: any}>} */\r\n    this.pageTextCache = new Cache();\r\n\r\n    /**\r\n     * Sometimes there are too many words on a page, and the browser becomes near\r\n     * unusable. For now don't render text layer for pages with too many words.\r\n     */\r\n    this.maxWordRendered = 2500;\r\n\r\n    this.selectionObserver = new SelectionObserver('.BRtextLayer', this._onSelectionChange);\r\n  }\r\n\r\n  /**\r\n   * @param {'started' | 'cleared'} type\r\n   * @param {HTMLElement} target\r\n   */\r\n  _onSelectionChange = (type, target) => {\r\n    if (type === 'started') {\r\n      this.textSelectingMode(target);\r\n    } else if (type === 'cleared') {\r\n      this.defaultMode(target);\r\n    } else {\r\n      throw new Error(`Unknown type ${type}`);\r\n    }\r\n  }\r\n\r\n  init() {\r\n    this.selectionObserver.attach();\r\n\r\n    // Only fetch the full djvu xml if the single page url isn't there\r\n    if (this.options.singlePageDjvuXmlUrl) return;\r\n    this.djvuPagesPromise = $.ajax({\r\n      type: \"GET\",\r\n      url: applyVariables(this.options.fullDjvuXmlUrl, this.optionVariables),\r\n      dataType: this.options.jsonp ? \"jsonp\" : \"html\",\r\n      cache: true,\r\n      error: (e) => undefined\r\n    }).then((res) => {\r\n      try {\r\n        const xmlMap = $.parseXML(res);\r\n        return xmlMap && $(xmlMap).find(\"OBJECT\");\r\n      } catch (e) {\r\n        return undefined;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {number} index\r\n   * @returns {Promise<HTMLElement|undefined>}\r\n   */\r\n  async getPageText(index) {\r\n    if (this.options.singlePageDjvuXmlUrl) {\r\n      const cachedEntry = this.pageTextCache.entries.find(x => x.index == index);\r\n      if (cachedEntry) {\r\n        return cachedEntry.response;\r\n      }\r\n      const res = await $.ajax({\r\n        type: \"GET\",\r\n        url: applyVariables(this.options.singlePageDjvuXmlUrl, this.optionVariables, { pageIndex: index }),\r\n        dataType: this.options.jsonp ? \"jsonp\" : \"html\",\r\n        cache: true,\r\n        error: (e) => undefined,\r\n      });\r\n      try {\r\n        const xmlDoc = $.parseXML(res);\r\n        const result = xmlDoc && $(xmlDoc).find(\"OBJECT\")[0];\r\n        this.pageTextCache.add({ index, response: result });\r\n        return result;\r\n      } catch (e) {\r\n        return undefined;\r\n      }\r\n    } else {\r\n      const XMLpagesArr = await this.djvuPagesPromise;\r\n      if (XMLpagesArr) return XMLpagesArr[index];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Intercept copied text to remove any styling applied to it\r\n   * @param {JQuery} $container\r\n   */\r\n  interceptCopy($container) {\r\n    $container[0].addEventListener('copy', (event) => {\r\n      const selection = document.getSelection();\r\n      event.clipboardData.setData('text/plain', selection.toString());\r\n      event.preventDefault();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Applies mouse events when in default mode\r\n   * @param {HTMLElement} textLayer\r\n   */\r\n  defaultMode(textLayer) {\r\n    const $pageContainer = $(textLayer).closest('.BRpagecontainer');\r\n    textLayer.style.pointerEvents = \"none\";\r\n    $pageContainer.find(\"img\").css(\"pointer-events\", \"auto\");\r\n\r\n    $(textLayer).off(\".textSelectPluginHandler\");\r\n    const startedMouseDown = this.mouseIsDown;\r\n    let skipNextMouseup = this.mouseIsDown;\r\n    if (startedMouseDown) {\r\n      textLayer.style.pointerEvents = \"auto\";\r\n    }\r\n\r\n    // Need to stop propagation to prevent DragScrollable from\r\n    // blocking selection\r\n    $(textLayer).on(\"mousedown.textSelectPluginHandler\", (event) => {\r\n      this.mouseIsDown = true;\r\n      if ($(event.target).is(\".BRwordElement, .BRspace\")) {\r\n        event.stopPropagation();\r\n      }\r\n    });\r\n\r\n    $(textLayer).on(\"mouseup.textSelectPluginHandler\", (event) => {\r\n      this.mouseIsDown = false;\r\n      textLayer.style.pointerEvents = \"none\";\r\n      if (skipNextMouseup) {\r\n        skipNextMouseup = false;\r\n        event.stopPropagation();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * This mode is active while there is a selection on the given textLayer\r\n   * @param {HTMLElement} textLayer\r\n   */\r\n  textSelectingMode(textLayer) {\r\n    const $pageContainer = $(textLayer).closest('.BRpagecontainer');\r\n    // Make text layer consume all events\r\n    textLayer.style.pointerEvents = \"all\";\r\n    // Block img from getting long-press to save while selecting\r\n    $pageContainer.find(\"img\").css(\"pointer-events\", \"none\");\r\n\r\n    $(textLayer).off(\".textSelectPluginHandler\");\r\n\r\n    $(textLayer).on('mousedown.textSelectPluginHandler', (event) => {\r\n      this.mouseIsDown = true;\r\n      event.stopPropagation();\r\n    });\r\n\r\n    // Prevent page flip on click\r\n    $(textLayer).on('mouseup.textSelectPluginHandler', (event) => {\r\n      this.mouseIsDown = false;\r\n      event.stopPropagation();\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Initializes text selection modes if there is a text layer on the page\r\n   * @param {JQuery} $container\r\n   */\r\n  stopPageFlip($container) {\r\n    /** @type {JQuery<HTMLElement>} */\r\n    const $textLayer = $container.find('.BRtextLayer');\r\n    if (!$textLayer.length) return;\r\n    $textLayer.each((i, s) => this.defaultMode(s));\r\n    this.interceptCopy($container);\r\n  }\r\n\r\n  /**\r\n   * @param {PageContainer} pageContainer\r\n   */\r\n  async createTextLayer(pageContainer) {\r\n    const pageIndex = pageContainer.page.index;\r\n    const $container = pageContainer.$container;\r\n    const $textLayers = $container.find('.BRtextLayer');\r\n    if ($textLayers.length) return;\r\n    const XMLpage = await this.getPageText(pageIndex);\r\n    if (!XMLpage) return;\r\n    recursivelyAddCoords(XMLpage);\r\n\r\n    const totalWords = $(XMLpage).find(\"WORD\").length;\r\n    if (totalWords > this.maxWordRendered) {\r\n      console.log(`Page ${pageIndex} has too many words (${totalWords} > ${this.maxWordRendered}). Not rendering text layer.`);\r\n      return;\r\n    }\r\n\r\n    const textLayer = createDIVPageLayer(pageContainer.page, 'BRtextLayer');\r\n    const ratioW = parseFloat(pageContainer.$container[0].style.width) / pageContainer.page.width;\r\n    const ratioH = parseFloat(pageContainer.$container[0].style.height) / pageContainer.page.height;\r\n    textLayer.style.transform = `scale(${ratioW}, ${ratioH})`;\r\n    textLayer.setAttribute(\"dir\", this.rtl ? \"rtl\" : \"ltr\");\r\n\r\n    const ocrParagraphs = $(XMLpage).find(\"PARAGRAPH[coords]\").toArray();\r\n    const paragEls = ocrParagraphs.map(p => {\r\n      const el = this.renderParagraph(p);\r\n      textLayer.appendChild(el);\r\n      return el;\r\n    });\r\n\r\n    // Fix up paragraph positions\r\n    const paragraphRects = determineRealRects(textLayer, '.BRparagraphElement');\r\n    let yAdded = 0;\r\n    for (const [ocrParagraph, paragEl] of zip(ocrParagraphs, paragEls)) {\r\n      const ocrParagBounds = $(ocrParagraph).attr(\"coords\").split(\",\").map(parseFloat);\r\n      const realRect = paragraphRects.get(paragEl);\r\n      const [ocrLeft, , ocrRight, ocrTop] = ocrParagBounds;\r\n      const newStartMargin = this.rtl ? (realRect.right - ocrRight) : (ocrLeft - realRect.left);\r\n      const newTop = ocrTop - (realRect.top + yAdded);\r\n\r\n      paragEl.style[this.rtl ? 'marginRight' : 'marginLeft'] = `${newStartMargin}px`;\r\n      paragEl.style.marginTop = `${newTop}px`;\r\n      yAdded += newTop;\r\n      textLayer.appendChild(paragEl);\r\n    }\r\n    $container.append(textLayer);\r\n    this.stopPageFlip($container);\r\n  }\r\n\r\n  /**\r\n   * @param {HTMLElement} ocrParagraph\r\n   * @returns {HTMLParagraphElement}\r\n   */\r\n  renderParagraph(ocrParagraph) {\r\n    const paragEl = document.createElement('p');\r\n    paragEl.classList.add('BRparagraphElement');\r\n    const [paragLeft, paragBottom, paragRight, paragTop] = $(ocrParagraph).attr(\"coords\").split(\",\").map(parseFloat);\r\n    const wordHeightArr = [];\r\n    const lines = $(ocrParagraph).find(\"LINE[coords]\").toArray();\r\n    if (!lines.length) return paragEl;\r\n\r\n\r\n    for (const [prevLine, line, nextLine] of lookAroundWindow(genMap(lines, augmentLine))) {\r\n      const isLastLineOfParagraph = line.ocrElement == lines[lines.length - 1];\r\n      const lineEl = document.createElement('span');\r\n      lineEl.classList.add('BRlineElement');\r\n\r\n      for (const [wordIndex, currWord] of line.words.entries()) {\r\n        const [, bottom, right, top] = $(currWord).attr(\"coords\").split(',').map(parseFloat);\r\n        const wordHeight = bottom - top;\r\n        wordHeightArr.push(wordHeight);\r\n\r\n        if (wordIndex == 0 && prevLine?.lastWord.textContent.trim().endsWith('-')) {\r\n          // ideally prefer the next line to determine the left position,\r\n          // since the previous line could be the first line of the paragraph\r\n          // and hence have an incorrectly indented first word.\r\n          // E.g. https://archive.org/details/driitaleofdaring00bachuoft/page/360/mode/2up\r\n          const [newLeft, , , ] = $((nextLine || prevLine).firstWord).attr(\"coords\").split(',').map(parseFloat);\r\n          $(currWord).attr(\"coords\", `${newLeft},${bottom},${right},${top}`);\r\n        }\r\n\r\n        const wordEl = document.createElement('span');\r\n        wordEl.setAttribute(\"class\", \"BRwordElement\");\r\n        wordEl.textContent = currWord.textContent.trim();\r\n\r\n        if (wordIndex > 0) {\r\n          const space = document.createElement('span');\r\n          space.classList.add('BRspace');\r\n          space.textContent = ' ';\r\n          lineEl.append(space);\r\n\r\n          // Edge ignores empty elements (like BRspace), so add another\r\n          // space to ensure Edge's ReadAloud works correctly.\r\n          lineEl.appendChild(document.createTextNode(' '));\r\n        }\r\n\r\n        lineEl.appendChild(wordEl);\r\n      }\r\n\r\n      const hasHyphen = line.lastWord.textContent.trim().endsWith('-');\r\n      const lastWordEl = lineEl.children[lineEl.children.length - 1];\r\n      if (hasHyphen && !isLastLineOfParagraph) {\r\n        lastWordEl.textContent = lastWordEl.textContent.trim().slice(0, -1);\r\n        lastWordEl.classList.add('BRwordElement--hyphen');\r\n      }\r\n\r\n      paragEl.appendChild(lineEl);\r\n      if (!isLastLineOfParagraph && !hasHyphen) {\r\n        // Edge does not correctly have spaces between the lines.\r\n        paragEl.appendChild(document.createTextNode(' '));\r\n      }\r\n    }\r\n\r\n    wordHeightArr.sort((a, b) => a - b);\r\n    const paragWordHeight = wordHeightArr[Math.floor(wordHeightArr.length * 0.85)] + 4;\r\n    paragEl.style.left = `${paragLeft}px`;\r\n    paragEl.style.top = `${paragTop}px`;\r\n    paragEl.style.width = `${paragRight - paragLeft}px`;\r\n    paragEl.style.height = `${paragBottom - paragTop}px`;\r\n    paragEl.style.fontSize = `${paragWordHeight}px`;\r\n\r\n    // Fix up sizes - stretch/crush words as necessary using letter spacing\r\n    let wordRects = determineRealRects(paragEl, '.BRwordElement');\r\n    const ocrWords = $(ocrParagraph).find(\"WORD\").toArray();\r\n    const wordEls = paragEl.querySelectorAll('.BRwordElement');\r\n    for (const [ocrWord, wordEl] of zip(ocrWords, wordEls)) {\r\n      const realRect = wordRects.get(wordEl);\r\n      const [left, , right ] = $(ocrWord).attr(\"coords\").split(',').map(parseFloat);\r\n      let ocrWidth = right - left;\r\n      // Some books (eg theworksofplato01platiala) have a space _inside_ the <WORD>\r\n      // element. That makes it impossible to determine the correct positining\r\n      // of everything, but to avoid the BRspace's being width 0, which makes selection\r\n      // janky on Chrome Android, assume the space is the same width as one of the\r\n      // letters.\r\n      if (ocrWord.textContent.endsWith(' ')) {\r\n        ocrWidth = ocrWidth * (ocrWord.textContent.length - 1) / ocrWord.textContent.length;\r\n      }\r\n      const diff = ocrWidth - realRect.width;\r\n      wordEl.style.letterSpacing = `${diff / (ocrWord.textContent.length - 1)}px`;\r\n    }\r\n\r\n    // Stretch/crush lines as necessary using line spacing\r\n    // Recompute rects after letter spacing\r\n    wordRects = determineRealRects(paragEl, '.BRwordElement');\r\n    const spaceRects = determineRealRects(paragEl, '.BRspace');\r\n\r\n    const ocrLines = $(ocrParagraph).find(\"LINE[coords]\").toArray();\r\n    const lineEls = Array.from(paragEl.querySelectorAll('.BRlineElement'));\r\n\r\n    let ySoFar = paragTop;\r\n    for (const [ocrLine, lineEl] of zip(ocrLines, lineEls)) {\r\n      // shift words using marginLeft to align with the correct x position\r\n      const words = $(ocrLine).find(\"WORD\").toArray();\r\n      // const ocrLineLeft = Math.min(...words.map(w => parseFloat($(w).attr(\"coords\").split(',')[0])));\r\n      let xSoFar = this.rtl ? paragRight : paragLeft;\r\n      for (const [ocrWord, wordEl] of zip(words, lineEl.querySelectorAll('.BRwordElement'))) {\r\n        // start of line, need to compute the offset relative to the OCR words\r\n        const wordRect = wordRects.get(wordEl);\r\n        const [ocrLeft, , ocrRight ] = $(ocrWord).attr(\"coords\").split(',').map(parseFloat);\r\n        const diff = (this.rtl ? -(ocrRight - xSoFar) : ocrLeft - xSoFar);\r\n\r\n        if (wordEl.previousElementSibling) {\r\n          const space = wordEl.previousElementSibling;\r\n          space.style.letterSpacing = `${diff - spaceRects.get(space).width}px`;\r\n        } else {\r\n          wordEl.style[this.rtl ? 'paddingRight' : 'paddingLeft'] = `${diff}px`;\r\n        }\r\n        if (this.rtl) xSoFar -= diff + wordRect.width;\r\n        else xSoFar += diff + wordRect.width;\r\n      }\r\n      // And also fix y position\r\n      const ocrLineTop = Math.min(...words.map(w => parseFloat($(w).attr(\"coords\").split(',')[3])));\r\n      const diff = ocrLineTop - ySoFar;\r\n      if (lineEl.previousElementSibling) {\r\n        lineEl.previousElementSibling.style.lineHeight = `${diff}px`;\r\n        ySoFar += diff;\r\n      }\r\n    }\r\n\r\n    // The last line will have a line height subtracting from the paragraph height\r\n    lineEls[lineEls.length - 1].style.lineHeight = `${paragBottom - ySoFar}px`;\r\n\r\n    // Edge does not include a newline for some reason when copying/pasting the <p> els\r\n    paragEl.appendChild(document.createElement('br'));\r\n    return paragEl;\r\n  }\r\n}\r\n\r\nexport class BookreaderWithTextSelection extends BookReader {\r\n  init() {\r\n    const options = Object.assign({}, DEFAULT_OPTIONS, this.options.plugins.textSelection);\r\n    if (options.enabled) {\r\n      this.textSelectionPlugin = new TextSelectionPlugin(options, this.options.vars, this.pageProgression);\r\n      // Write this back; this way the plugin is the source of truth, and BR just\r\n      // contains a reference to it.\r\n      this.options.plugins.textSelection = options;\r\n      this.textSelectionPlugin.init();\r\n\r\n      new SelectionObserver('.BRtextLayer', (selectEvent) => {\r\n        // Track how often selection is used\r\n        if (selectEvent == 'started') {\r\n          this.archiveAnalyticsSendEvent?.('BookReader', 'SelectStart');\r\n\r\n          // Set a class on the page to avoid hiding it when zooming/etc\r\n          this.refs.$br.find('.BRpagecontainer--hasSelection').removeClass('BRpagecontainer--hasSelection');\r\n          $(window.getSelection().anchorNode).closest('.BRpagecontainer').addClass('BRpagecontainer--hasSelection');\r\n        }\r\n      }).attach();\r\n    }\r\n\r\n    super.init();\r\n  }\r\n\r\n  /**\r\n   * @param {number} index\r\n   */\r\n  _createPageContainer(index) {\r\n    const pageContainer = super._createPageContainer(index);\r\n    // Disable if thumb mode; it's too janky\r\n    // .page can be null for \"pre-cover\" region\r\n    if (this.mode !== this.constModeThumb && pageContainer.page) {\r\n      this.textSelectionPlugin?.createTextLayer(pageContainer);\r\n    }\r\n    return pageContainer;\r\n  }\r\n}\r\nwindow.BookReader = BookreaderWithTextSelection;\r\nexport default BookreaderWithTextSelection;\r\n\r\n\r\n/**\r\n * @param {HTMLElement} parentEl\r\n * @param {string} selector\r\n * @returns {Map<Element, Rect>}\r\n */\r\nfunction determineRealRects(parentEl, selector) {\r\n  const initals = {\r\n    position: parentEl.style.position,\r\n    visibility: parentEl.style.visibility,\r\n    top: parentEl.style.top,\r\n    left: parentEl.style.left,\r\n    transform: parentEl.style.transform,\r\n  };\r\n  parentEl.style.position = 'absolute';\r\n  parentEl.style.visibility = 'hidden';\r\n  parentEl.style.top = '0';\r\n  parentEl.style.left = '0';\r\n  parentEl.style.transform = 'none';\r\n  document.body.appendChild(parentEl);\r\n  const rects = new Map(\r\n    Array.from(parentEl.querySelectorAll(selector))\r\n      .map(wordEl => {\r\n        const origRect = wordEl.getBoundingClientRect();\r\n        return [wordEl, new Rect(\r\n          origRect.left + window.scrollX,\r\n          origRect.top + window.scrollY,\r\n          origRect.width,\r\n          origRect.height,\r\n        )];\r\n      })\r\n  );\r\n  document.body.removeChild(parentEl);\r\n  Object.assign(parentEl.style, initals);\r\n  return rects;\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} line\r\n */\r\nfunction augmentLine(line) {\r\n  const words = $(line).find(\"WORD\").toArray();\r\n  return {\r\n    ocrElement: line,\r\n    words,\r\n    firstWord: words[0],\r\n    lastWord: words[words.length - 1],\r\n  };\r\n}\r\n\r\n/**\r\n * @template TFrom, TTo\r\n * Generator version of map\r\n * @param {Iterable<TFrom>} gen\r\n * @param {function(TFrom): TTo} fn\r\n * @returns {Iterable<TTo>}\r\n */\r\nexport function* genMap(gen, fn) {\r\n  for (const x of gen) yield fn(x);\r\n}\r\n\r\n/**\r\n * @template T\r\n * Generator that provides a sliding window of 3 elements,\r\n * prev, current, and next.\r\n * @param {Iterable<T>} gen\r\n * @returns {Iterable<[T | undefined, T, T | undefined]>}\r\n */\r\nexport function* lookAroundWindow(gen) {\r\n  let prev = undefined;\r\n  let cur = undefined;\r\n  let next = undefined;\r\n  for (const x of gen) {\r\n    if (typeof cur !== 'undefined') {\r\n      next = x;\r\n      yield [prev, cur, next];\r\n    }\r\n    prev = cur;\r\n    cur = x;\r\n    next = undefined;\r\n  }\r\n\r\n  if (typeof cur !== 'undefined') {\r\n    yield [prev, cur, next];\r\n  }\r\n}\r\n\r\n/**\r\n * @template T1, T2\r\n * Lazy zip implementation to avoid importing lodash\r\n * Expects iterators to be of the same length\r\n * @param {Iterable<T1>} gen1\r\n * @param {Iterable<T2>} gen2\r\n * @returns {Iterable<[T1, T2]>}\r\n */\r\nexport function* zip(gen1, gen2) {\r\n  const it1 = gen1[Symbol.iterator]();\r\n  const it2 = gen2[Symbol.iterator]();\r\n  while (true) {\r\n    const r1 = it1.next();\r\n    const r2 = it2.next();\r\n    if (r1.done && r2.done) {\r\n      return;\r\n    }\r\n    if (r1.done || r2.done) {\r\n      throw new Error('zip: one of the iterators is done');\r\n    }\r\n    yield [r1.value, r2.value];\r\n  }\r\n}\r\n\r\n/**\r\n * [left, bottom, right, top]\r\n * @param {Array<[number, number, number, number]>} bounds\r\n * @returns {[number, number, number, number]}\r\n */\r\nfunction determineBounds(bounds) {\r\n  let leftMost = Infinity;\r\n  let bottomMost = -Infinity;\r\n  let rightMost = -Infinity;\r\n  let topMost = Infinity;\r\n\r\n  for (const [left, bottom, right, top] of bounds) {\r\n    leftMost = Math.min(leftMost, left);\r\n    bottomMost = Math.max(bottomMost, bottom);\r\n    rightMost = Math.max(rightMost, right);\r\n    topMost = Math.min(topMost, top);\r\n  }\r\n\r\n  return [leftMost, bottomMost, rightMost, topMost];\r\n}\r\n\r\n/**\r\n * Recursively traverses the XML tree and adds coords\r\n * which are the bounding box of all child coords\r\n * @param {Element} xmlEl\r\n */\r\nfunction recursivelyAddCoords(xmlEl) {\r\n  if ($(xmlEl).attr('coords') || !xmlEl.children) {\r\n    return;\r\n  }\r\n\r\n  const children = $(xmlEl).children().toArray();\r\n  if (children.length === 0) {\r\n    return;\r\n  }\r\n\r\n  for (const child of children) {\r\n    recursivelyAddCoords(child);\r\n  }\r\n\r\n  const childCoords = [];\r\n\r\n  for (const child of children) {\r\n    if (!$(child).attr('coords')) continue;\r\n    childCoords.push($(child).attr('coords').split(',').map(parseFloat));\r\n  }\r\n\r\n  const boundingCoords = determineBounds(childCoords);\r\n  if (Math.abs(boundingCoords[0]) != Infinity) {\r\n    $(xmlEl).attr('coords', boundingCoords.join(','));\r\n  }\r\n}\r\n\r\n/**\r\n * Basically a polyfill for the native DOMRect class\r\n */\r\nclass Rect {\r\n  /**\r\n   * @param {number} x\r\n   * @param {number} y\r\n   * @param {number} width\r\n   * @param {number} height\r\n   */\r\n  constructor(x, y, width, height) {\r\n    this.x = x;\r\n    this.y = y;\r\n    this.width = width;\r\n    this.height = height;\r\n  }\r\n\r\n  get right() { return this.x + this.width; }\r\n  get bottom() { return this.y + this.height; }\r\n  get top() { return this.y; }\r\n  get left() { return this.x; }\r\n}\r\n","/**\r\n * @typedef {String} StringWithVars\r\n * A template string with {{foo}} style variables\r\n * Also supports filters, like {{bookPath|urlencode}} (See APPLY_FILTERS for the\r\n * supported list of filters)\r\n **/\r\n\r\n/**\r\n * @param {StringWithVars|String} template\r\n * @param { {[varName: string]: { toString: () => string} } } vars\r\n * @param { {[varName: string]: { toString: () => string} } } [overrides]\r\n */\r\nexport function applyVariables(template, vars, overrides = {}, possibleFilters = APPLY_FILTERS) {\r\n  return template?.replace(/\\{\\{([^}]*?)\\}\\}/g, ($0, $1) => {\r\n    if (!$1) return $0;\r\n    /** @type {string} */\r\n    const expression = $1;\r\n    const [varName, ...filterNames] = expression.split('|').map(x => x.trim());\r\n    const defined = varName in overrides || varName in vars;\r\n\r\n    // If it's not defined, don't expand it at all\r\n    if (!defined) return $0;\r\n\r\n    const value = varName in overrides ? overrides[varName]\r\n      : varName in vars ? vars[varName] : null;\r\n    const filters = filterNames.map(n => possibleFilters[n]);\r\n    return filters.reduce((acc, cur) => cur(acc), value && value.toString());\r\n  });\r\n}\r\n\r\n/** @type { {[filterName: String]:( string => string)} } */\r\nexport const APPLY_FILTERS = {\r\n  urlencode: encodeURIComponent,\r\n};\r\n"],"names":["SelectionObserver","constructor","selector","handler","_defineProperty","sel","window","getSelection","selecting","toString","target","$","anchorNode","closest","isCollapsed","attach","document","addEventListener","_onSelectionChange","detach","removeEventListener","createDIVPageLayer","applyVariables","BookReader","DEFAULT_OPTIONS","enabled","fullDjvuXmlUrl","singlePageDjvuXmlUrl","jsonp","Cache","maxSize","entries","add","entry","length","shift","push","TextSelectionPlugin","options","optionVariables","pageProgression","type","textSelectingMode","defaultMode","Error","djvuPagesPromise","rtl","pageTextCache","maxWordRendered","selectionObserver","init","ajax","url","dataType","cache","error","e","undefined","then","res","xmlMap","parseXML","find","getPageText","index","cachedEntry","x","response","pageIndex","xmlDoc","result","XMLpagesArr","interceptCopy","$container","event","selection","clipboardData","setData","preventDefault","textLayer","$pageContainer","style","pointerEvents","css","off","startedMouseDown","mouseIsDown","skipNextMouseup","on","is","stopPropagation","stopPageFlip","$textLayer","each","i","s","createTextLayer","pageContainer","page","$textLayers","XMLpage","recursivelyAddCoords","totalWords","console","log","ratioW","parseFloat","width","ratioH","height","transform","setAttribute","ocrParagraphs","toArray","paragEls","map","p","el","renderParagraph","appendChild","paragraphRects","determineRealRects","yAdded","ocrParagraph","paragEl","zip","ocrParagBounds","attr","split","realRect","get","ocrLeft","ocrRight","ocrTop","newStartMargin","right","left","newTop","top","marginTop","append","createElement","classList","paragLeft","paragBottom","paragRight","paragTop","wordHeightArr","lines","prevLine","line","nextLine","lookAroundWindow","genMap","augmentLine","isLastLineOfParagraph","ocrElement","lineEl","wordIndex","currWord","words","bottom","wordHeight","lastWord","textContent","trim","endsWith","newLeft","firstWord","wordEl","space","createTextNode","hasHyphen","lastWordEl","children","slice","sort","a","b","paragWordHeight","Math","floor","fontSize","wordRects","ocrWords","wordEls","querySelectorAll","ocrWord","ocrWidth","diff","letterSpacing","spaceRects","ocrLines","lineEls","Array","from","ySoFar","ocrLine","xSoFar","wordRect","previousElementSibling","ocrLineTop","min","w","lineHeight","BookreaderWithTextSelection","Object","assign","plugins","textSelection","textSelectionPlugin","vars","selectEvent","archiveAnalyticsSendEvent","refs","$br","removeClass","addClass","_createPageContainer","mode","constModeThumb","parentEl","initals","position","visibility","body","rects","Map","origRect","getBoundingClientRect","Rect","scrollX","scrollY","removeChild","gen","fn","prev","cur","next","gen1","gen2","it1","Symbol","iterator","it2","r1","r2","done","value","determineBounds","bounds","leftMost","Infinity","bottomMost","rightMost","topMost","max","xmlEl","child","childCoords","boundingCoords","abs","join","y","template","overrides","possibleFilters","APPLY_FILTERS","replace","$0","$1","expression","varName","filterNames","defined","filters","n","reduce","acc","urlencode","encodeURIComponent"],"sourceRoot":""}