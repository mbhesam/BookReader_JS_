{"version":3,"file":"plugins/plugin.archive_analytics.js","mappings":"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","sources":["webpack://@internetarchive/bookreader/./src/plugins/plugin.archive_analytics.js"],"sourcesContent":["/* global BookReader */\r\n/**\r\n * Plugin for Archive.org analytics\r\n */\r\njQuery.extend(BookReader.defaultOptions, {\r\n  enableArchiveAnalytics: true,\r\n  /** Provide a means of debugging, cause otherwise it's impossible to test locally */\r\n  debugArchiveAnaltyics: false,\r\n});\r\n\r\nBookReader.prototype.init = (function(super_) {\r\n  return function() {\r\n    super_.call(this);\r\n\r\n    if (this.options.enableArchiveAnalytics) {\r\n      this.bind(BookReader.eventNames.fragmentChange, () => this.archiveAnalyticsSendFragmentChange());\r\n    }\r\n  };\r\n})(BookReader.prototype.init);\r\n\r\n/** @private */\r\nBookReader.prototype.archiveAnalyticsSendFragmentChange = function() {\r\n  if (!window.archive_analytics) {\r\n    return;\r\n  }\r\n\r\n  const prevFragment = this.archiveAnalyticsSendFragmentChange.prevFragment;\r\n\r\n  const params = this.paramsFromCurrent();\r\n  const newFragment = this.fragmentFromParams(params);\r\n\r\n  if (prevFragment != newFragment) {\r\n    const values = {\r\n      bookreader: \"user_changed_view\",\r\n      itemid: this.bookId,\r\n      cache_bust: Math.random()\r\n    };\r\n    // EEK!  offsite embedding and /details/ page books look the same in analytics, otherwise!\r\n    values.offsite = 1;\r\n    values.details = 0;\r\n    try {\r\n      values.offsite = window.top.location.hostname.match(/\\.archive.org$/)\r\n        ? 0\r\n        : 1;\r\n      values.details =\r\n        !values.offsite && window.top.location.pathname.match(/^\\/details\\//)\r\n          ? 1\r\n          : 0;\r\n    } catch (e) {}\r\n    // avoids embed cross site exceptions -- but on (+) side, means it is and keeps marked offite!\r\n\r\n    // Send bookreader ping\r\n    window.archive_analytics.send_ping(values, null, \"augment_for_ao_site\");\r\n\r\n    // Also send tracking event ping\r\n    const additionalEventParams = this.options.lendingInfo && this.options.lendingInfo.loanId\r\n      ? { loanId: this.options.lendingInfo.loanId }\r\n      : {};\r\n    window.archive_analytics.send_event('BookReader', 'UserChangedView', window.location.pathname, additionalEventParams);\r\n\r\n    this.archiveAnalyticsSendFragmentChange.prevFragment = newFragment;\r\n  }\r\n};\r\n\r\n/**\r\n * Sends a tracking \"Event\". See https://developers.google.com/analytics/devguides/collection/protocol/v1/parameters#events\r\n * @param {string} category\r\n * @param {string} action\r\n * @param {number} [value] (must be an int)\r\n * @param {Object} [additionalEventParams]\r\n */\r\nBookReader.prototype.archiveAnalyticsSendEvent = function(category, action, value, additionalEventParams) {\r\n  if (!this.options.enableArchiveAnalytics) return;\r\n\r\n  if (this.options.debugArchiveAnaltyics) {\r\n    console.log(\"archiveAnalyticsSendEvent\", arguments, window.archive_analytics);\r\n  }\r\n\r\n  if (!window.archive_analytics) return;\r\n\r\n  additionalEventParams = additionalEventParams || {};\r\n  if (typeof(value) == 'number') {\r\n    additionalEventParams.ev = value;\r\n  }\r\n  window.archive_analytics.send_event(category, action, null, additionalEventParams);\r\n};\r\n"],"names":["jQuery","extend","BookReader","defaultOptions","enableArchiveAnalytics","debugArchiveAnaltyics","prototype","init","super_","call","options","bind","eventNames","fragmentChange","archiveAnalyticsSendFragmentChange","window","archive_analytics","prevFragment","params","paramsFromCurrent","newFragment","fragmentFromParams","values","bookreader","itemid","bookId","cache_bust","Math","random","offsite","details","top","location","hostname","match","pathname","e","send_ping","additionalEventParams","lendingInfo","loanId","send_event","archiveAnalyticsSendEvent","category","action","value","console","log","arguments","ev"],"sourceRoot":""}